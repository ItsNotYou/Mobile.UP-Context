<!DOCTYPE html>
<html>
<head>
 <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
        <!-- Always use the same header for production -->
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=medium-dpi" />

        <link rel="stylesheet" type="text/css" href="css/up-theme.min.css" />
        <link rel="stylesheet" href="css/jquery.mobile.icons.min.css" />
        <link rel="stylesheet" href="css/jquery.mobile.structure-1.4.0.min.css" />
        <link rel="stylesheet" type="text/css" href="css/jqm-datebox.min.css" />
        <link rel="stylesheet" type="text/css" href="css/up-style.css" />

        <!-- Javascript Files -->

        <!-- Core Libraries -->
        <script type="text/javascript" src="phonegap.js"></script>
        <script src="js/lib/jquery-1.10.2.min.js"></script>
        <script src="js/lib/jquery.mobile-1.4.1.min.js"></script>
        <script src="js/lib/q.min.js"></script>
        <script src="js/lib/underscore.min.js"></script>
        <script src="js/lib/jqm-datebox.core.min.js"></script>
        <script src="js/lib/jqm-datebox.mode.calbox.min.js"></script>
        <script src="js/lib/jquery.mobile.datebox.i18n.en_US.utf8.js"></script>
        <script id="panel-init">
           $(function () {
               $("[data-role='panel']").panel().enhanceWithin();
           });
       </script>
       <script src="js/app.js"></script>
        <!-- Module Libraries -->
        <!-- Mensa -->
        <script src="js/lib/modules/mensa-logic.js"></script>
        <!-- Sitemaps -->
        <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
        <script src="js/sitemap.js"></script>

        <title>UP.App</title>

        <script>
        $(function(){

          var dateHelper = {};

          // I give this function a German name,
          // because someone introduced German weekday names as keys in opening.json
          var tage = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
          var wochentag = function(date) {
            if (date) {
              return tage[date.getDay()]
            }
          };

          var hoursColonMinutes = function(date){
            if (date) {
              return date.getHours() + ':' + date.getMinutes();
            }
          };

          var openingForWochentag = function(timesArr, wochentag) {
            if (! _.isArray(timesArr)){ return;}
            var day = _.find(timesArr, function(timesForDay){
              console.log('find day', wochentag, timesArr, timesForDay);
              return timesForDay.day == wochentag;
            });
            if (day){
              return day.opening;
            }
            return false;
          }

          var statusAtPlaceAndDate = function(place, date) {
            if (date && place) {
              var _wochentag = wochentag(date);
              var opening = openingForWochentag(place.times, _wochentag);

              if (opening === false) {
                return 'closed';
              };

              if ((opening == null) || _.isString(opening)) {
                return 'notsure';
              };

              var time = hoursColonMinutes(date);
              if (_.isArray(opening)) {
                var open = _.some(opening, function(fromTo){
                  return ((fromTo[0] < time) && (fromTo[1] > time))
                });
                return (open)? 'open' : 'closed';
              }

              return 'problem'
            }
          };

          var statusPlaceOpenNow = function(place) {
            var now = new Date();
            return statusAtPlaceAndDate(place, now);
          };

          // TODO: JSON parsen und aktuelle uhrzeit herausfinden
          // Ampel fÃ¼r den heutigen Wochentag rendern

          var renderOpenings = function(openings) {
            var placeTemplate = render('openings');
            var placesList = $('#openings > ul');
            _.each(openings, function(place){
              placesList.append(placeTemplate(place));
            });
          };

          var fromToDaytimeString = function(from, to) {
            var string = '' + from + ' - ' + to + ' Uhr';
            // console.log('string',string);
            return string;
          };

          var addTextToTimes = function (openings) {
            _.each(openings, function(place) {
              // console.log('place',place);
              _.each(place.times, function(day){
                // console.log('day', day);
                if(_.isString(day.opening)) {
                  day.opening_text = day.opening;
                  return;
                }

                if(_.isArray(day.opening)){
                  var text = _.map(day.opening, function(fromToArr){
                    // console.log('fromToArr', fromToArr);
                    if (_.isArray(fromToArr)) {
                      return fromToDaytimeString(fromToArr[0], fromToArr[1]);
                    } else {
                      return fromToArr;
                    }
                  }).join(' | ');
                  day.opening_text = text;
                  // console.log('text', text);
                  return;
                }

                console.log('Neither String nor Array');
              })
            });
            return openings;
          };

          $.ajax({
            url: 'js/json/opening.json',
            method: 'GET',
            dataType: 'html',
            async: false,
            success: function(json) {
              var data = $.parseJSON(json);
              var openings = _.sortBy(data, 'name');

              openings = addTextToTimes(openings);

              var now = new Date();
              _.each(openings, function(place){
                place.statusOpenNow = statusAtPlaceAndDate(place, now);
              });

              console.log(openings);
              renderOpenings(openings);
              $("#opening").trigger("create");
            }
          });
        });
      </script>

</head>
<body>


  <div data-role="page" id="opening">
    <!-- Start Header -->
    <div data-role="header" data-position="fixed">
      <a href="#nav-panel" data-role="button" data-icon="false" data-inline="true" class="menubutton">Menue</a>
          <a href="plans.html" data-role="button" data-icon="false" data-inline="true" data-transition="slidefade" data-direction="reverse" class="back">Back</a>

      <h1>&Ouml;ffnungszeiten</h1>
    </div>
    <!-- End Header -->
    <!-- Start Main - Navigation -->
    <div data-role="content" data-theme="c">
      <form>
        <input data-type="search" id="searchForOpening"
          placeholder="Eintr&auml;ge filtern" />
      </form>

<!--
       <div id="sorter">
        <ul data-role="listview">
          <li><span>A</span></li>
          <li><span>B</span></li>
          <li><span>P</span></li>
        </ul>
      </div>
 -->
    <div id="openings">
      <ul data-role="listview" data-autodividers="true" data-inset="true"
        data-filter="true" data-input="#searchForOpening" id="placesList" data-hidedividers="true">
        <!-- opening.templ -->
      </ul>
    </div>
  </div>
  <!-- End Main - Navigation -->
</body>
</html>